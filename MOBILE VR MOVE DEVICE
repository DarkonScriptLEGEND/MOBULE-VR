-- LocalScript in StarterPlayerScripts
-- VR-like + Normal Touch Look Camera for Mobile (R6)
-- Gyroscope = realistic head tracking
-- No gyroscope or preference = normal drag-to-look (like PC/mobile FPS)

local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

-- Force first-person
player.CameraMode = Enum.CameraMode.LockFirstPerson

local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")
local rootPart = character:WaitForChild("HumanoidRootPart")

-- Prevent character from auto-turning with camera
humanoid.AutoRotate = false

-- === SETTINGS ===
local GYRO_SENSITIVITY = 1.5
local TOUCH_SENSITIVITY = 0.004
local LERP_SPEED = 0.25        -- How smooth the camera feels
local MAX_PITCH = math.rad(85) -- Almost straight up/down

-- === STATE VARIABLES ===
local useGyro = UserInputService.GyroscopeEnabled
local initialDeviceCFrame = nil

local currentYaw = 0
local currentPitch = 0

local touchStartPos = nil
local isTouchLooking = false

-- === FUNCTIONS ===
local function recalibrateGyro()
    if not useGyro then return end
    local success, _, cf = pcall(UserInputService.GetDeviceRotation, UserInputService)
    if success then
        initialDeviceCFrame = cf
        print("Gyro recalibrated")
    end
end

local function updateCamera()
    local headPos = rootPart.Position + Vector3.new(0, 1.6, 0) -- R6 head height

    local rotationCFrame = CFrame.new()

    if useGyro and initialDeviceCFrame then
        -- === GYRO MODE (realistic VR-like) ===
        local success, _, deviceCf = pcall(UserInputService.GetDeviceRotation, UserInputService)
        if success then
            local relative = initialDeviceCFrame:Inverse() * deviceCf
            local _, yaw, _ = relative:ToEulerAnglesYXZ()
            local pitch = -relative:ToOrientation() -- X axis

            pitch = math.clamp(pitch * GYRO_SENSITIVITY, -MAX_PITCH, MAX_PITCH)
            yaw = -yaw * GYRO_SENSITIVITY

            rotationCFrame = CFrame.Angles(0, yaw, 0) * CFrame.Angles(pitch, 0, 0)
        end
    else
        -- === NORMAL TOUCH LOOK (like any mobile FPS) ===
        rotationCFrame = CFrame.Angles(0, -currentYaw, 0) * CFrame.Angles(currentPitch, 0, 0)
    end

    camera.CFrame = CFrame.new(headPos) * rotationCFrame
end

-- === INPUT HANDLING ===
-- Start dragging to look
UserInputService.TouchStarted:Connect(function(input, processed)
    if processed then return end
    if useGyro then return end -- Don't allow touch look when gyro is active

    touchStartPos = input.Position
    isTouchLooking = true
end)

-- Drag to rotate camera
UserInputService.TouchMoved:Connect(function(input, processed)
    if processed or not isTouchLooking or useGyro then return end

    local delta = input.Position - touchStartPos
    currentYaw = currentYaw - delta.X * TOUCH_SENSITIVITY
    currentPitch = math.clamp(currentPitch - delta.Y * TOUCH_SENSITIVITY, -MAX_PITCH, MAX_PITCH)

    touchStartPos = input.Position -- Important: update start pos for smooth drag
end)

UserInputService.TouchEnded:Connect(function(input, processed)
    if not useGyro then
        isTouchLooking = false
    end
end)

-- Double-tap to reset view
local lastTap = 0
UserInputService.InputBegan:Connect(function(input, processed)
    if processed then return end
    if input.UserInputType == Enum.UserInputType.Touch then
        local now = tick()
        if now - lastTap < 0.3 then
            if useGyro then
                recalibrateGyro()
            else
                currentYaw = 0
                currentPitch = 0
                print("Touch view reset")
            end
        end
        lastTap = now
    end
end)

-- === MAIN LOOP ===
RunService.RenderStepped:Connect(function()
    -- Re-force first-person in case something changes it
    if player.CameraMode ~= Enum.CameraMode.LockFirstPerson then
        player.CameraMode = Enum.CameraMode.LockFirstPerson
    end

    updateCamera()
end)

-- === CHARACTER RESPAWN ===
player.CharacterAdded:Connect(function(newChar)
    character = newChar
    humanoid = newChar:WaitForChild("Humanoid")
    rootPart = newChar:WaitForChild("HumanoidRootPart")
    humanoid.AutoRotate = false

    if useGyro then
        task.wait(1)
        recalibrateGyro()
    end
end)

-- Initial gyro calibration
if useGyro then
    task.wait(1)
    recalibrateGyro()
end

print("VR + Normal Touch Camera System Loaded")
